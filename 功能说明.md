# 护理床电机控制系统 - 功能说明文档

## 系统概述

本系统基于STM32F103C8T6，控制7路直流电机，实现护理床的翻身、起背、屈腿等功能。

### 电机定义
- **电机0（Motor0）**：翻身电机
- **电机1（Motor1）**：起背电机
- **电机2（Motor2）**：屈腿电机
- **电机3-6**：其他功能电机

---

## 特殊功能详解

### 1. 左翻身（指令：0x08 0x00）

#### 执行前判断条件
- **必须满足**：电机1（起背电机）位置在 **3250-3450** 范围内
- **判断逻辑**：确保起背电机已归位，防止翻身时起背电机干涉

#### 判断不通过
- 输出错误信息：`Motor1 position out of range: [当前位置] (required: 3250-3450)`
- 拒绝执行，直接返回

#### 判断通过后的执行流程
1. **电机0（翻身电机）反转**，持续运动直到到达极限位置
2. **停止条件**：2秒内位置不变（说明已到达物理极限）
3. **停止电机0**
4. **清零操作**：
   - 将电机0的位置清零（`motors[0].position = 0`）
   - 清零霍尔计数器（`hallA_count = 0, hallB_count = 0`）
   - 保存位置0到EEPROM

#### 最终状态
- **电机0位置**：0（极限位置，已清零）
- **电机1位置**：保持在3250-3450（起背归位状态）

---

### 2. 右翻身（指令：0x08 0x01）

#### 执行前判断条件
- **必须满足**：电机1（起背电机）位置在 **3250-3450** 范围内
- **判断逻辑**：确保起背电机已归位，防止翻身时起背电机干涉

#### 判断不通过
- 输出错误信息：`Motor1 position out of range: [当前位置] (required: 3250-3450)`
- 拒绝执行，直接返回

#### 判断通过后的执行流程
1. **检查电机0当前位置**：
   - 如果 `motors[0].position < 3100`：
     - **电机0（翻身电机）前进**到位置 **3100**
     - 到达后停止
   - 如果 `motors[0].position >= 3100`：
     - 已经在目标位置或超过，不执行动作

#### 最终状态
- **电机0位置**：3100（右翻位置）
- **电机1位置**：保持在3250-3450（起背归位状态）

---

### 3. 起背（指令：0x08 0x03）

#### 执行前判断条件
- **必须满足**：电机0（翻身电机）位置在 **2000-2200** 范围内
- **判断逻辑**：确保翻身电机已归位，防止起背时翻身电机干涉

#### 判断不通过
- 输出错误信息：`Motor0 position out of range: [当前位置] (required: 2000-2200)`
- 拒绝执行，直接返回

#### 判断通过后的执行流程
1. **电机1（起背电机）反转**，开始运动
2. **注意**：这是非阻塞指令，电机1会持续反转，需要手动发送停止指令

#### 最终状态
- **电机0位置**：保持在2000-2200（翻身归位状态）
- **电机1位置**：根据用户需求反转到指定位置（需手动停止）

---

### 4. 平躺（指令：0x08 0x02）

平躺指令会根据当前床的状态，自动判断需要归位哪些电机。

#### 状态判断逻辑

##### 情况1：两个条件都满足
**判断条件**：
- 电机0位置在 **2000-2200** 范围内（翻身已归位）
- **且** 电机1位置在 **3250-3450** 范围内（起背已归位）

**执行动作**：
- 只需要移动 **电机2（屈腿电机）** 到位置 **2700**

**最终状态**：
- **电机0位置**：保持在2000-2200
- **电机1位置**：保持在3250-3450
- **电机2位置**：2700

---

##### 情况2：状态1 - 翻身后归位
**判断条件**：
- 电机1位置在 **3250-3450** 范围内（起背已归位）
- 电机0位置**不在** 2000-2200 范围内（翻身未归位）

**执行动作**（两个电机同时运动）：
- **电机0（翻身电机）** 移动到位置 **2100**
- **电机2（屈腿电机）** 移动到位置 **2700**
- 各自到达目标位置后独立停止

**最终状态**：
- **电机0位置**：2100（翻身归位）
- **电机1位置**：保持在3250-3450（起背归位）
- **电机2位置**：2700（屈腿归位）

---

##### 情况3：状态2 - 起背后归位
**判断条件**：
- 电机0位置在 **2000-2200** 范围内（翻身已归位）
- 电机1位置**不在** 3250-3450 范围内（起背未归位）

**执行动作**（两个电机同时运动）：
- **电机1（起背电机）** 前进到极限位置（**3250-3450**）
  - 停止条件：2秒内位置不变（到达物理极限）
- **电机2（屈腿电机）** 移动到位置 **2700**
- 各自到达目标位置后独立停止

**最终状态**：
- **电机0位置**：保持在2000-2200（翻身归位）
- **电机1位置**：3250-3450（起背归位，到达极限）
- **电机2位置**：2700（屈腿归位）

---

##### 情况4：条件都不满足
**判断条件**：
- 电机0位置**不在** 2000-2200 范围内
- **且** 电机1位置**不在** 3250-3450 范围内

**执行动作**：
- 输出错误信息，显示当前电机0和电机1的位置
- 拒绝执行平躺指令

---

## 位置参数总结表

| 功能 | 判断条件 | 执行动作 | 目标位置 |
|------|---------|---------|---------|
| **左翻身** | 电机1在3250-3450 | 电机0反转到极限 | 电机0 → 0（清零） |
| **右翻身** | 电机1在3250-3450 | 电机0前进 | 电机0 → 3100 |
| **起背** | 电机0在2000-2200 | 电机1反转（非阻塞） | 电机1 → 用户控制 |
| **平躺-情况1** | 电机0在2000-2200 且 电机1在3250-3450 | 电机2移动 | 电机2 → 2700 |
| **平躺-情况2** | 电机1在3250-3450 | 电机0、电机2同时移动 | 电机0 → 2100<br>电机2 → 2700 |
| **平躺-情况3** | 电机0在2000-2200 | 电机1、电机2同时移动 | 电机1 → 3250-3450（极限）<br>电机2 → 2700 |

---

## 关键位置说明

### 电机0（翻身电机）
- **0**：左翻极限位置（清零后）
- **2000-2200**：翻身归位范围（平躺状态）
- **2100**：翻身归位目标位置
- **3100**：右翻目标位置

### 电机1（起背电机）
- **3250-3450**：起背归位范围（前进极限位置）
- **3300**：起背归位理论位置（物理限位会自动停在3250-3450范围内）

### 电机2（屈腿电机）
- **2700**：屈腿归位位置（平躺状态）

---

## 安全机制

1. **位置检查**：所有特殊功能执行前都会检查相关电机位置，防止干涉
2. **极限检测**：通过"2秒内位置不变"判断电机到达物理极限
3. **过流保护**：每个电机电流超过3A自动停机
4. **位置记忆**：所有电机位置自动保存到EEPROM，断电不丢失

---

## 调试信息

所有功能执行时都会通过串口输出详细信息：
- 判断条件是否满足
- 当前电机位置
- 执行动作
- 到达目标位置的提示

建议调试时打开串口监视器（9600波特率）查看实时信息。

---

**文档版本**：1.0
**最后更新**：2026-02-02
**对应代码版本**：newmotor.ino
